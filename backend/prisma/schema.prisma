datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/* --- Enums --- */
enum UserRole {
  STUDENT
  ORGANIZER
  ADMIN
}

enum EventVisibility {
  OWN
  SELECTED
  ALL
}

enum PaymentGateway {
  RAZORPAY
  STRIPE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum ClubMembershipStatus {
  PENDING
  APPROVED
  REJECTED
  LEFT
}

enum RecruitmentStatus {
  OPEN
  CLOSED
}

enum Currency {
  INR
  USD
  EUR
  // add others you need
}

/* --- Models --- */

model College {
  id                   Int                    @id @default(autoincrement())
  name                 String
  code                 String                 @unique
  users                User[]
  clubs                Club[]
  events               Event[]
  allowedEventColleges EventAllowedCollege[]
  logo                 String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
}

model Club {
  id           Int                @id @default(autoincrement())
  name         String
  collegeId    Int
  createdBy    Int                 // organizer who created the club (references User.id)
  creator      User               @relation("UserCreatedClubs", fields: [createdBy], references: [id], onDelete: SetNull)
  description  String?
  college      College            @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  events       Event[]
  memberships  ClubMembership[]
  recruitments ClubRecruitment[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  isDeleted    Boolean            @default(false)

  @@index([collegeId])
  @@index([createdBy])
}

model User {
  id                   Int            @id @default(autoincrement())
  name                 String
  email                String         @unique
  password             String
  role                 UserRole
  collegeId            Int
  college              College        @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  registrations        Registration[] @relation("EventRegistrant")
  scannedRegistrations Registration[] @relation("AttendanceScanner")
  memberships          ClubMembership[]
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  // Clubs created by this user (organizer)
  createdClubs         Club[]         @relation("UserCreatedClubs")
  
  // Events created by this user (organizer)
  createdEvents        Event[]        @relation("UserCreatedEvents")
  
  // Auth-related relations
  refreshTokens         RefreshToken[]
  emailVerifications   EmailVerification[]
  
  // Audit logs
  auditLogs            AuditLog[]

  // extra auth/account fields
  isEmailVerified      Boolean        @default(false)
  emailVerifiedAt      DateTime?
  deletedAt            DateTime?

  @@index([collegeId])
}

model Event {
  id              Int                   @id @default(autoincrement())
  title           String
  description     String?
  dateTime        DateTime
  venue           String
  collegeId       Int
  clubId          Int?                  // optional: if null, college-wide event
  createdBy       Int                   // organizer ID (references User.id)
  creator         User                  @relation("UserCreatedEvents", fields: [createdBy], references: [id], onDelete: SetNull)
  visibility      EventVisibility
  isPaid          Boolean               @default(false)
  price           Int?                  // in smallest currency unit (paise for INR, cents for USD)
  currency        Currency?             // prefer enum for ISO codes
  college         College               @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  club            Club?                 @relation(fields: [clubId], references: [id], onDelete: SetNull)
  registrations   Registration[]
  allowedColleges EventAllowedCollege[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  isDeleted       Boolean               @default(false)

  @@index([collegeId])
  @@index([clubId])
  @@index([dateTime])
  @@index([visibility])
  @@index([isPaid])
  @@index([createdBy])
}

model EventAllowedCollege {
  id        Int      @id @default(autoincrement())
  eventId   Int
  collegeId Int
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  college   College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@unique([eventId, collegeId])
  @@index([eventId])
  @@index([collegeId])
}

model Registration {
  id                Int             @id @default(autoincrement())
  userId            Int
  eventId           Int
  qrPayload         String?         // signed QR token id (not raw secret)
  qrImageUrl        String?
  attended          Boolean         @default(false)
  scannedAt         DateTime?       // timestamp when QR was scanned for attendance
  scannedBy         Int?            // organizer/admin user ID who scanned the QR
  scanner           User?           @relation("AttendanceScanner", fields: [scannedBy], references: [id], onDelete: SetNull)
  paidAmount        Int?
  currency          Currency?
  paymentGateway    PaymentGateway?
  paymentId         String?         // gateway order/session id
  paymentStatus     PaymentStatus?
  paymentAttemptedAt DateTime?
  paymentConfirmedAt DateTime?
  paymentFailureReason String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  user              User            @relation("EventRegistrant", fields: [userId], references: [id], onDelete: Cascade)
  event             Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([attended])
  @@index([scannedAt])
  @@index([paymentStatus])
  @@index([paymentId])
}

model ClubMembership {
  id         Int                  @id @default(autoincrement())
  userId     Int
  clubId     Int
  status     ClubMembershipStatus @default(PENDING)
  joinedAt   DateTime?
  leftAt     DateTime?
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  club       Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@unique([userId, clubId])
  @@index([userId])
  @@index([clubId])
  @@index([status])
}

model ClubRecruitment {
  id          Int              @id @default(autoincrement())
  clubId      Int
  title       String
  description String?
  status      RecruitmentStatus @default(OPEN)
  startDate   DateTime
  endDate     DateTime?
  requirements String? // e.g., "Open to all students"
  club        Club             @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([clubId])
  @@index([status])
  @@index([startDate])
}

/* --- Additional utility models --- */

model RefreshToken {
  id          Int      @id @default(autoincrement())
  token       String   @unique
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revoked     Boolean  @default(false)

  @@index([userId])
}

model EmailVerification {
  id         Int      @id @default(autoincrement())
  userId     Int
  token      String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?
  actor      User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
  action     String
  targetType String?
  targetId   Int?
  payload    Json?
  createdAt  DateTime @default(now())
}
